---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import PropiedadCard from '../components/PropiedadCard.astro';
import Filtros from '../components/Filtros.astro';
import { getPropiedadesPublicadas, generarSlug, getImagenUrl, getAmenities } from '../services/api';

// Obtener par√°metros de b√∫squeda
const url = new URL(Astro.request.url);
const filtros = {
  zona: url.searchParams.get('zona') || undefined,
  ciudad: url.searchParams.get('ciudad') || undefined,
  tipoOperacion: url.searchParams.get('tipoOperacion') || undefined,
  precioMin: url.searchParams.get('precioMin') ? Number(url.searchParams.get('precioMin')) : undefined,
  precioMax: url.searchParams.get('precioMax') ? Number(url.searchParams.get('precioMax')) : undefined,
  superficieMin: url.searchParams.get('superficieMin') ? Number(url.searchParams.get('superficieMin')) : undefined,
  superficieMax: url.searchParams.get('superficieMax') ? Number(url.searchParams.get('superficieMax')) : undefined,
  buscar: url.searchParams.get('buscar') || url.searchParams.get('busqueda') || undefined,
};

// Obtener propiedades de la API
let propiedadesFiltradas = await getPropiedadesPublicadas(filtros);

console.log('üè† Propiedades recibidas:', propiedadesFiltradas);

// Ordenar
const orden = url.searchParams.get('orden') || 'reciente';
propiedadesFiltradas = propiedadesFiltradas.sort((a, b) => {
  const precioA = a.precio || 0;
  const precioB = b.precio || 0;
  if (orden === 'precio-asc') return precioA - precioB;
  if (orden === 'precio-desc') return precioB - precioA;
  // Por defecto ordenar por ID descendente (m√°s recientes primero)
  const idA = a.id_propiedad || a.id || 0;
  const idB = b.id_propiedad || b.id || 0;
  return String(idB).localeCompare(String(idA));
});

// Transformar propiedades al formato esperado por los componentes
const propiedadesTransformadas = propiedadesFiltradas.map(prop => {
  const detalles = prop.detalles || prop.detalle || {};
  const direccion = prop.direccion || {};
  const imagenes = prop.imagenes || [];
  
  return {
    id: String(prop.id_propiedad || prop.id || ''),
    slug: generarSlug({ 
      id: prop.id_propiedad || prop.id,
      titulo: prop.titulo_propiedad || prop.titulo,
      slug: prop.slug 
    } as any),
    estado: 'activa',
    titulo: prop.titulo_propiedad || prop.titulo || 'Sin t√≠tulo',
    descripcion: prop.descripcion_propiedad || prop.descripcion || 'Sin descripci√≥n',
    descripcionBreve: (prop.descripcion_propiedad || prop.descripcion || '').substring(0, 100) + '...',
    tipoOperacion: (prop.tipo_operacion_propiedad || prop.tipo_operacion || '').toLowerCase().includes('venta') ? 'venta' : 'alquiler',
    tipoPropiedad: 'propiedad',
    zona: direccion.zona_direccion || direccion.zona || direccion.barrio_direccion || direccion.barrio || 'Sin especificar',
    ciudad: direccion.ciudad_direccion || direccion.ciudad || 'Sin especificar',
    direccionResumida: direccion ? `${direccion.calle_direccion || direccion.calle || 'Sin calle'}, ${direccion.zona_direccion || direccion.zona || ''}` : 'Sin direcci√≥n',
    coordenadas: (direccion.latitud_direccion || direccion.latitud) && (direccion.longitud_direccion || direccion.longitud) ? {
      lat: direccion.latitud_direccion || direccion.latitud,
      lng: direccion.longitud_direccion || direccion.longitud
    } : undefined,
    precio: prop.precio_publicado_propiedad || prop.precio_propiedad || prop.precio || 0,
    superficieTotal: prop.superficie_propiedad || prop.superficie_total_propiedad || prop.superficie_total || 0,
    superficieConstruida: prop.superficie_construida_propiedad || prop.superficie_construida || 0,
    dormitorios: detalles.num_dormitorios || 0,
    banos: detalles.num_banos || 0,
    amenities: getAmenities(detalles),
    imagenPortada: getImagenUrl(imagenes.find(img => img.es_portada_imagen || img.es_portada)?.url_imagen || imagenes[0]?.url_imagen),
    galeria: imagenes.map(img => getImagenUrl(img.url_imagen || img.url)),
    destacada: false,
    fechaPublicacion: prop.fecha_publicacion_propiedad || prop.fecha_creacion_propiedad || prop.fecha_creacion || new Date().toISOString()
  };
});

// Funci√≥n helper para construir URLs con par√°metros
function buildURL(params: Record<string, string | number | undefined>) {
  const searchParams = new URLSearchParams();
  
  Object.entries(params).forEach(([key, value]) => {
    if (value !== undefined && value !== null && value !== '') {
      searchParams.set(key, String(value));
    }
  });
  
  return `?${searchParams.toString()}`;
}

// Paginaci√≥n simple
const paginaActual = Number(url.searchParams.get('pagina')) || 1;
const propiedadesPorPagina = 9;
const totalPaginas = Math.ceil(propiedadesTransformadas.length / propiedadesPorPagina);
const inicio = (paginaActual - 1) * propiedadesPorPagina;
const fin = inicio + propiedadesPorPagina;
const propiedadesPaginadas = propiedadesTransformadas.slice(inicio, fin);
---

<Layout 
  title="Cat√°logo de Propiedades" 
  description="Explora nuestro cat√°logo completo de propiedades en venta y alquiler. Filtra por zona, precio, tipo y m√°s."
>
  <Header />
  
  <main class="catalog-page">
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">Cat√°logo de Propiedades</h1>
        <p class="page-subtitle">
          {propiedadesTransformadas.length} {propiedadesTransformadas.length === 1 ? 'propiedad encontrada' : 'propiedades encontradas'}
        </p>
      </div>

      <!-- Filtros -->
      <div class="filters-wrapper">
        <Filtros showAdvanced={true} />
      </div>

      <!-- Resultados -->
      <div class="results-section">
        <!-- Barra de herramientas -->
        <div class="toolbar">
          <p class="results-count">
            Mostrando {inicio + 1}-{Math.min(fin, propiedadesTransformadas.length)} de {propiedadesTransformadas.length}
          </p>
          
          <form method="GET" class="sort-form">
            {/* Mantener filtros actuales */}
            {Object.entries(filtros).map(([key, value]) => 
              value !== undefined && <input type="hidden" name={key} value={String(value)} />
            )}
            {paginaActual > 1 && <input type="hidden" name="pagina" value={String(paginaActual)} />}
            
            <label for="orden" class="sort-label">Ordenar por:</label>
            <select id="orden" name="orden" class="sort-select" onchange="this.form.submit()">
              <option value="reciente" selected={orden === 'reciente'}>M√°s recientes</option>
              <option value="precio-asc" selected={orden === 'precio-asc'}>Precio: menor a mayor</option>
              <option value="precio-desc" selected={orden === 'precio-desc'}>Precio: mayor a menor</option>
            </select>
          </form>
        </div>

        <!-- Grid de propiedades -->
        {propiedadesPaginadas.length > 0 ? (
          <div class="properties-grid">
            {propiedadesPaginadas.map(propiedad => (
              <PropiedadCard propiedad={propiedad} />
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
              <line x1="11" y1="8" x2="11" y2="14"></line>
              <line x1="8" y1="11" x2="14" y2="11"></line>
            </svg>
            <h3>No se encontraron propiedades</h3>
            <p>Intenta ajustar los filtros o buscar con otros criterios</p>
            <a href="/propiedades" class="btn btn-primary">Ver todas las propiedades</a>
          </div>
        )}

        <!-- Paginaci√≥n -->
        {totalPaginas > 1 && (
          <nav class="pagination" aria-label="Paginaci√≥n">
            {paginaActual > 1 && (
              <a 
                href={buildURL({...filtros, orden, pagina: paginaActual - 1})}
                class="pagination-link"
              >
                ‚Üê Anterior
              </a>
            )}

            <div class="pagination-numbers">
              {Array.from({ length: totalPaginas }, (_, i) => i + 1).map(num => (
                <a
                  href={buildURL({...filtros, orden, pagina: num})}
                  class:list={['pagination-number', { active: num === paginaActual }]}
                >
                  {num}
                </a>
              ))}
            </div>

            {paginaActual < totalPaginas && (
              <a 
                href={buildURL({...filtros, orden, pagina: paginaActual + 1})}
                class="pagination-link"
              >
                Siguiente ‚Üí
              </a>
            )}
          </nav>
        )}
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<style>
  .catalog-page {
    padding: var(--spacing-3xl) 0;
  }

  .page-header {
    text-align: center;
    margin-bottom: var(--spacing-3xl);
  }

  .page-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--spacing-md);
  }

  .page-subtitle {
    font-size: var(--font-size-lg);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .filters-wrapper {
    margin-bottom: var(--spacing-3xl);
  }

  .results-section {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xl);
  }

  .toolbar {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    align-items: flex-start;
    justify-content: space-between;
    padding: var(--spacing-lg);
    background-color: var(--color-bg-secondary);
    border-radius: var(--border-radius-md);
  }

  .results-count {
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .sort-form {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .sort-label {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text);
    margin: 0;
  }

  .sort-select {
    padding: var(--spacing-xs) var(--spacing-md);
    font-size: var(--font-size-sm);
    border: var(--border-width) solid var(--color-border);
    border-radius: var(--border-radius-md);
    background-color: var(--color-bg);
    cursor: pointer;
  }

  .properties-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-xl);
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-lg);
    padding: var(--spacing-4xl);
    text-align: center;
    color: var(--color-text-secondary);
  }

  .empty-state svg {
    opacity: 0.5;
  }

  .empty-state h3 {
    font-size: var(--font-size-2xl);
    color: var(--color-text);
    margin: 0;
  }

  .empty-state p {
    font-size: var(--font-size-base);
    margin: 0;
  }

  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-md);
    padding: var(--spacing-xl) 0;
  }

  .pagination-link {
    padding: var(--spacing-sm) var(--spacing-lg);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-primary);
    text-decoration: none;
    border: var(--border-width) solid var(--color-border);
    border-radius: var(--border-radius-md);
    transition: all var(--transition-fast);
  }

  .pagination-link:hover {
    background-color: var(--color-bg-secondary);
    border-color: var(--color-primary);
  }

  .pagination-numbers {
    display: flex;
    gap: var(--spacing-xs);
  }

  .pagination-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    text-decoration: none;
    border-radius: var(--border-radius-md);
    transition: all var(--transition-fast);
  }

  .pagination-number:hover {
    background-color: var(--color-bg-secondary);
    color: var(--color-text);
  }

  .pagination-number.active {
    background-color: var(--color-primary);
    color: white;
  }

  /* Responsive - Mobile */
  @media (max-width: 767px) {
    .page-header {
      padding: var(--spacing-2xl) 0 var(--spacing-xl);
    }

    .page-title {
      font-size: var(--font-size-2xl);
    }

    .page-description {
      font-size: var(--font-size-sm);
    }

    .results-count {
      font-size: var(--font-size-sm);
    }

    .sort-controls {
      gap: var(--spacing-xs);
    }

    .sort-label {
      display: none;
    }

    .sort-select {
      font-size: var(--font-size-sm);
      padding: var(--spacing-xs) var(--spacing-sm);
    }

    .pagination {
      gap: var(--spacing-xs);
    }

    .page-btn {
      min-width: 36px;
      height: 36px;
      font-size: var(--font-size-sm);
    }

    .page-info {
      font-size: var(--font-size-xs);
    }
  }

  @media (min-width: 768px) {
    .toolbar {
      flex-direction: row;
      align-items: center;
    }
  }
</style>
