---
interface Props {
  lat: number;
  lng: number;
  titulo: string;
  direccion: string;
}

const { lat, lng, titulo, direccion } = Astro.props;
const mapId = `map-${Math.random().toString(36).substr(2, 9)}`;
---

<div id={mapId} class="mapa-propiedad"></div>

<script define:vars={{ mapId, lat, lng, titulo, direccion }}>
  // Cargar Leaflet din√°micamente solo en el cliente
  if (typeof window !== 'undefined') {
    // Agregar CSS de Leaflet
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
    link.crossOrigin = '';
    document.head.appendChild(link);

    // Cargar JS de Leaflet
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
    script.crossOrigin = '';
    
    script.onload = () => {
      // Inicializar el mapa despu√©s de que Leaflet se cargue
      const mapElement = document.getElementById(mapId);
      if (!mapElement) return;

      // Crear el mapa
      const map = L.map(mapId).setView([lat, lng], 15);

      // Agregar capa de tiles de OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      // Crear icono personalizado
      const customIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });

      // Agregar marcador con popup
      const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
      marker.bindPopup(`
        <div style="text-align: center; padding: 8px;">
          <strong style="font-size: 14px;">${titulo}</strong><br>
          <span style="font-size: 12px; color: #666;">${direccion}</span>
        </div>
      `).openPopup();

      // Ajustar el mapa despu√©s de que se renderice
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    };
    
    document.head.appendChild(script);
  }
</script>

<style>
  .mapa-propiedad {
    width: 100%;
    height: 400px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    background: #f5f5f5;
    position: relative;
  }

  @media (max-width: 768px) {
    .mapa-propiedad {
      height: 300px;
    }
  }

  /* Loading state */
  .mapa-propiedad::before {
    content: 'üìç Cargando mapa...';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #999;
    font-size: 14px;
    z-index: 1;
  }

  /* Asegurar que Leaflet se vea bien */
  :global(.leaflet-container) {
    font-family: inherit;
  }

  :global(.leaflet-popup-content-wrapper) {
    border-radius: 8px;
  }

  :global(.leaflet-popup-content) {
    margin: 0;
  }
</style>
